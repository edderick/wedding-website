<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>Edward and Bethan's Wedding</title>

        <link rel="stylesheet" 
              href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" 
              integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" 
              crossorigin="anonymous">

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

        <script> 
            function numGuestsChange() {
                const numGuests = parseInt(document.getElementById('numGuests').value, 10);

                for (let i = 1; i < 1 + numGuests; i++) {
                    const elem = document.getElementById(`guest_${i}`).style.display = 'block';
                }
                for (let i = numGuests+1; i < 10; i++) {
                    const elem = document.getElementById(`guest_${i}`).style.display = 'none';
                }
            }

            function changeAttend(i) {
                const isAttending = document.getElementById(`guest_${i}_attending`).checked;
                document.getElementById(`guest_${i}_has_diet`).value = 'false';
                document.getElementById(`guest_${i}_diet`).style.display = isAttending ? 'block' : 'none'; 
                changeDiet(i);
            }

            function changeDiet(i) {
                const hasDiet = document.getElementById(`guest_${i}_has_diet`).checked;
                document.getElementById(`guest_${i}_diet_details_text`).value = '';
                document.getElementById(`guest_${i}_diet_details`).style.display = hasDiet ? 'block' : 'none'; 
            }

            function handleSubmit() {
                let guests = [];

                const numGuests = parseInt(document.getElementById('numGuests').value, 10);

                for (let i = 1; i < 1 + numGuests; i++) {
                    const guest = {
                        firstname: document.getElementById(`guest_${i}_firstname`).value.trim(),
                        lastname: document.getElementById(`guest_${i}_lastname`).value.trim(),
                        isAttending: document.getElementById(`guest_${i}_attending`).checked ? 'true' : 'false',
                        hasDiet: document.getElementById(`guest_${i}_has_diet`).checked ? 'true' : 'false',
                        dietDetails: document.getElementById(`guest_${i}_diet_details_text`).value.trim(),
                    };

                    if (guest.firstname == '') {
                        alert(`Guest ${i} is missing a first name`);
                        return;
                    }

                    if (!guest.lastname) {
                        alert(`Guest ${i} is missing a last name`);
                        return;
                    }

                    if (guest.hasDiet == 'true' && !guest.dietDetails) {
                        alert(`Guest ${i} is missing diet details`);
                        return;
                    }

                    guests.push(guest);
                }

                console.log(JSON.stringify(guests));

				$.post("/update_rsvp", { guests: JSON.stringify(guests) }, (data) => {
                    if (data == 'OK') {
					   window.location.href = "/rsvp";
                    }
                    else if (data == 'NOPE') {
                        alert('Nice try!');
                    }
				});
            }

            function fillLastNames(index) {
                const lastname = document.getElementById(`guest_${index}_lastname`).value;
                const numGuests = parseInt(document.getElementById('numGuests').value, 10);
                for (let i = 1; i < 1 + numGuests; i++) {
                    document.getElementById(`guest_${i}_lastname`).value = lastname;
                }
            }

            function gotoMainSite() {
                const proceed = confirm("If you have any unsaved changes, they will be lost")
                if (proceed) {
                    window.location.href = '/site';
                }
            }
        </script>

    </head>
    <body>
        <div class='container'>
        <h1>RSVP for {{ email }}</h1>

        Number of guests you'd like to RSVP for:
        <select id='numGuests' onchange='numGuestsChange()' style='width: 100px'>
            {% for i in range(1, 10) %}
            <option value="{{i}}" {% if i == numGuestsSelected %} selected {% endif %}>{{i}}</option>
            {% endfor %}
        </select> 

        {% for guest in guests %}
        <div id="guest_{{loop.index}}"  {% if loop.index > numGuestsSelected %}style='display:none'{% endif %}>
            <h2>Guest {{loop.index}} {% if i == 1 %}(You!){% endif %}</h2>
            <form action="javascript:void()" class='ml-2'>
                
                <div class='form-row'>
                    <div class='form-group col-md-6'>
                        <label>First Name</label>
                        <input id="guest_{{loop.index}}_firstname" type="text" value='{{guest.firstname}}' class='form-control'/> 
                    </div>
                    <div class='form-group col-md-6'>
                        <label>
                            Last Name
                            {% if loop.index == 1 %}
                                <a href='#' onclick='fillLastNames({{loop.index}})'>(Fill all last names)</a>
                            {% endif %}
                        </label>
                        <input id="guest_{{loop.index}}_lastname" type="text" value='{{guest.lastname}}' class='form-control'/> 
                    </div>
                </div>
               
                <div class="form-group">
                    <div class="form-check">
                        <input id="guest_{{loop.index}}_attending" onchange="changeAttend({{loop.index}})"  class="form-check-input" type="checkbox" {% if guest.isAttending == 'true'%} checked {% endif %}>
                        <label class="form-check-label" for="guest_{{loop.index}}_attending">
                            Guest will be attending 
                        </label>
                    </div>
                </div>

                <div  id="guest_{{loop.index}}_diet" {% if guest.isAttending == 'false' %} style='display: none' {% endif %}>


                    <div class="form-group">
                        <div class="form-check">
                            <input id="guest_{{loop.index}}_has_diet" onchange="changeDiet({{loop.index}})"  class="form-check-input" type="checkbox" {% if guest.hasDiet == 'true'%} checked {% endif %}>
                            <label class="form-check-label" for="guest_{{loop.index}}_has_diet">
                                Guest has special dietary requirements <a href="#">(See Menu)</a>
                            </label>
                        </div>
                    </div>

                    <div class='form-row' id="guest_{{loop.index}}_diet_details" {% if guest.hasDiet == 'true' %} style='display: block' {% else %}  style='display: none' {% endif %}>
                        Please describe dietarty requirements:<br/> 
                        <textarea id='guest_{{loop.index}}_diet_details_text' class="form-control" rows='3' >{{guest.dietDetails}}</textarea>
                    </div>
                
                </div>
            </form>
            </div>
            {% endfor %}

            <center>
                <a href='#' onclick='handleSubmit()'>Save Changes</a> | <a href='#' onclick='gotoMainSite()'>Back to Main Site</a>
            </center>
        </div>
    </body>
</html>
